# -*- coding: utf-8 -*-
import os, webbrowser
from threading import Timer
from g4f.client import Client
from flask import Flask, request, render_template_string

# ---------------------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ----------------------
MODEL_NAME = "gpt-4o-mini"

SYSTEM_PROMPT_FA = (
    "ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± ÙØ§Ø±Ø³ÛŒ Ù‡Ø³ØªÛŒ Ú©Ù‡ ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Ø¨Ù‡ Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ø§Ø´ÛŒÙ† Ù¾Ø±Ø§ÛŒØ¯ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡ÛŒ. "
    "Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…ÙˆØ¶ÙˆØ¹ Ù¾Ø±Ø§ÛŒØ¯ Ø¨ÙˆØ¯ØŒ ØµØ±ÛŒØ­ Ø¨Ú¯Ùˆ: Â«Ù…Ù† ÙÙ‚Ø· Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±Ø§ÛŒØ¯ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ù…Â»."
    "Ø¬ÙˆØ§Ø¨ Ø¯Ù‚ÛŒÙ‚ØŒ ÙÙ†ÛŒ Ùˆ Ø±ÙˆØ§Ù† Ø¨Ø¯Ù‡."
)

# ---------------------- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ----------------------
def ask_g4f(messages):
    client = Client()
    resp = client.chat.completions.create(
        model=MODEL_NAME,
        messages=messages,
        temperature=0.2,
        max_tokens=500,
    )
    return resp.choices[0].message.content.strip()

# ---------------------- Flask ----------------------
app = Flask(__name__)
history = [{"role": "system", "content": SYSTEM_PROMPT_FA}]

HTML_TEMPLATE = """
<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>ğŸ¤– Ø±Ø¨Ø§Øª Ù¾Ø±Ø§ÛŒØ¯</title>
<style>
body { font-family: Tahoma, sans-serif; direction: rtl; margin: 30px; background-color: #f9f9f9; }
h1 { color: #2c3e50; }
textarea { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
input[type=submit] { padding: 10px 20px; }
div.response { background: #ecf0f1; padding: 15px; margin-top: 20px; border-radius: 8px; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>ğŸš— Ø±Ø¨Ø§Øª Ù…Ø®ØµÙˆØµ Ù…Ø§Ø´ÛŒÙ† Ù¾Ø±Ø§ÛŒØ¯</h1>
<p>Ù‡Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±Ø§ÛŒØ¯ Ø¯Ø§Ø±ÛŒ Ø¨Ù¾Ø±Ø³ØŒ Ù…Ù† Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù….</p>

<form method="post">
<textarea name="query" rows="3" placeholder="Ø³ÙˆØ§Ù„Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±Ø§ÛŒØ¯ Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³..." required></textarea>
<br>
<input type="submit" value="Ø¨Ù¾Ø±Ø³">
</form>

{% if answer %}
<div class="response">
<h3>ğŸ“¤ Ù¾Ø§Ø³Ø®:</h3>
<p>{{ answer }}</p>
</div>
{% endif %}
</body>
</html>
"""

@app.route("/", methods=["GET", "POST"])
def index():
    answer = None
    if request.method == "POST":
        q = (request.form.get("query") or "").strip()
        messages = history[-6:] + [
            {"role": "system", "content": SYSTEM_PROMPT_FA},
            {"role": "user", "content": q},
        ]
        try:
            model_answer = ask_g4f(messages)
        except Exception as e:
            model_answer = f"âŒ Ø®Ø·Ø§ Ø§Ø² g4f: {e}"

        answer = model_answer
        history.append({"role": "user", "content": q})
        history.append({"role": "assistant", "content": answer})

    return render_template_string(HTML_TEMPLATE, answer=answer)

def open_browser():
    webbrowser.open_new("http://127.0.0.1:5000/")

if __name__ == "__main__":
    Timer(1, open_browser).start()
    app.run()
